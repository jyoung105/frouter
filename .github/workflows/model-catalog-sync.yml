name: Model Catalog Sync

on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * *"
    - cron: "47 4 * * 1"

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: Sync model catalogs
    runs-on: ubuntu-latest
    concurrency:
      group: model-catalog-sync
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Install dependencies
        run: npm install

      - name: Sync model catalogs
        env:
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ARTIFICIAL_ANALYSIS_API_KEY: ${{ secrets.ARTIFICIAL_ANALYSIS_API_KEY }}
        run: |
          mkdir -p .tmp
          npx tsx scripts/update-models.ts --apply --report .tmp/model-sync-report.json

      - name: Build dist artifacts
        run: npm run build

      - name: Run unit + security tests
        run: node --test dist/tests/unit/*.test.js dist/tests/security/*.test.js

      - name: Read sync report
        id: report
        run: |
          node <<'NODE'
          const fs = require('fs');
          const p = '.tmp/model-sync-report.json';
          let unresolved = 0;
          let missing = 0;
          if (fs.existsSync(p)) {
            const r = JSON.parse(fs.readFileSync(p, 'utf8'));
            unresolved = (r.rankings?.unresolved_tier_models || []).length;
            missing = r.rankings?.missing_rankings || 0;
          }
          fs.appendFileSync(
            process.env.GITHUB_OUTPUT,
            `unresolved=${unresolved}\nmissing=${missing}\n`,
          );
          NODE

      - name: Detect changed files
        id: changes
        run: |
          if git diff --quiet -- model-rankings.json model-support.json; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload sync report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: model-catalog-sync-report
          path: .tmp/model-sync-report.json
          if-no-files-found: ignore

      - name: Create pull request
        id: cpr
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore(models): sync NIM/OpenRouter/OpenCode catalogs"
          branch: chore/model-catalog-sync
          delete-branch: true
          title: "chore(models): sync NIM/OpenRouter/OpenCode catalogs"
          body: |
            Automated model catalog sync.

            Updated files:
            - `model-rankings.json`
            - `model-support.json`

            Sync report:
            - unresolved tiers: ${{ steps.report.outputs.unresolved }}
            - missing ranking entries: ${{ steps.report.outputs.missing }}

            If unresolved tiers > 0, please verify tier values via Artificial Analysis.
          labels: |
            automated
            models
          add-paths: |
            model-rankings.json
            model-support.json

      - name: Add needs-tier-review label
        if: steps.cpr.outputs.pull-request-number != '' && steps.report.outputs.unresolved != '0'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number('${{ steps.cpr.outputs.pull-request-number }}'),
              labels: ['needs-tier-review'],
            });
